<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نظام الملاحظات الآمن المتقدم</title>
  <!-- إضافة ميتا خاصة بالتطبيق التقدمي -->
  <meta name="theme-color" content="#2c3e50">
  <link rel="manifest" href="manifest.json">

  <!-- إطار عمل التصميم (Shoelace) -->
  <link href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.0.0-beta.83/dist/themes/light.css" rel="stylesheet">
  <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.0.0-beta.83/dist/shoelace.js"></script>
  
  <!-- أنماط مخصصة -->
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --success-color: #27ae60;
      --danger-color: #e74c3c;
      --background-light: #f8f9fa;
      --background-dark: #1a1a1a;
    }

    body {
      font-family: 'Segoe UI', system-ui;
      background: var(--background-light);
      color: var(--primary-color);
      transition: all 0.3s ease;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .security-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin: 2rem 0;
    }

    .biometric-section {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
    }

    .editor-section {
      margin-top: 2rem;
      padding: 1rem;
    }

    #note-editor {
      min-height: 200px;
      border: 1px solid #ccc;
      border-radius: 0.5rem;
      padding: 1rem;
      background: #fff;
    }

    /* دعم الوضع الداكن */
    @media (prefers-color-scheme: dark) {
      body {
        background: var(--background-dark);
        color: #fff;
      }
      .biometric-section, .editor-section, #note-editor {
        background: #333;
        border-color: #555;
      }
    }
  </style>
</head>
<body>
  <!-- شاشة تسجيل الدخول الآمن -->
  <div class="container" id="auth-container">
    <sl-card class="security-grid">
      <!-- قسم المصادقة المتعددة العوامل -->
      <div class="biometric-section">
        <h2>🔒 تسجيل الدخول الآمن</h2>
        <sl-input type="text" label="اسم المستخدم" id="username" required></sl-input>
        <sl-input type="password" label="كلمة المرور" id="password" password-toggle required></sl-input>
        
        <!-- أسئلة أمان مخصصة -->
        <sl-select label="اختر سؤال الأمان" id="security-question">
          <sl-option value="1">ما اسم مدرستك الابتدائية؟</sl-option>
          <sl-option value="2">ما هو أول حيوان أليف لك؟</sl-option>
        </sl-select>
        <sl-input type="text" label="الإجابة" id="security-answer" required></sl-input>

        <!-- مصادقة بيومترية -->
        <sl-button variant="primary" id="biometric-auth">
          <sl-icon name="fingerprint"></sl-icon> تسجيل الدخول البيومتري
        </sl-button>
      </div>

      <!-- تسجيل الدخول بالتعرف على الوجه -->
      <div class="biometric-section">
        <h3>📸 تسجيل الدخول بالتعرف على الوجه</h3>
        <video id="face-video" width="300" height="225" autoplay muted playsinline></video>
        <canvas id="face-canvas" width="300" height="225" hidden></canvas>
        <sl-button id="start-face-auth">بدء المسح</sl-button>
      </div>
    </sl-card>
  </div>

  <!-- الواجهة الرئيسية بعد تسجيل الدخول -->
  <div class="container" id="main-app" hidden>
    <!-- شريط الأدوات المتقدم -->
    <sl-toolbar>
      <sl-dropdown>
        <sl-button slot="trigger" caret>ملف</sl-button>
        <sl-menu>
          <sl-menu-item id="new-note">ملاحظة جديدة</sl-menu-item>
          <sl-menu-item id="import">استيراد</sl-menu-item>
          <sl-menu-divider></sl-menu-divider>
          <sl-menu-item id="logout">تسجيل الخروج</sl-menu-item>
        </sl-menu>
      </sl-dropdown>

      <!-- التحكم متعدد اللغات -->
      <sl-select id="language-select" value="ar" style="width: 120px;">
        <sl-option value="ar">العربية</sl-option>
        <sl-option value="en">English</sl-option>
        <sl-option value="fr">Français</sl-option>
        <sl-option value="es">Español</sl-option>
      </sl-select>

      <!-- إدارة الأمان -->
      <sl-button-group>
        <sl-button id="2fa-setup">إعداد 2FA</sl-button>
        <sl-button variant="danger" id="lock-session">قفل الجلسة</sl-button>
      </sl-button-group>
    </sl-toolbar>

    <!-- محرر الملاحظات المتقدم -->
    <sl-card class="editor-section">
      <div id="note-editor" contenteditable="true" data-placeholder="ابدأ الكتابة هنا..."></div>
      <sl-button-group>
        <sl-button variant="success" id="save-note">حفظ</sl-button>
        <sl-button variant="primary" id="archive-note">أرشفة</sl-button>
        <sl-button variant="danger" id="delete-note">حذف</sl-button>
      </sl-button-group>
    </sl-card>

    <!-- قسم البحث والأرشيف -->
    <sl-card>
      <sl-input id="search-input" type="search" placeholder="ابحث في الأرشيف..."></sl-input>
      <div id="archive-results"></div>
    </sl-card>
  </div>

  <!-- عنصر حوار (Modal) لعرض التنبيهات والرسائل -->
  <sl-dialog label="تنبيه" id="modal-dialog">
    <div id="modal-content"></div>
    <sl-button slot="footer" variant="primary" id="close-modal">حسنًا</sl-button>
  </sl-dialog>

  <!-- مكتبات الأمان والترجمة والتعرف على الوجه -->
  <script src="https://cdn.jsdelivr.net/npm/i18next@21.6.10/i18next.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

  <script>
    'use strict';

    class SecureNotesSystem {
      constructor() {
        this.encryptionKey = null;
        this.iv = CryptoJS.lib.WordArray.random(16);
        this.currentUser = null;
        this.sessionTimeout = null;
        this.modelsPath = '/models'; // تأكد من توفر مجلد النماذج الخاص بالتعرف على الوجه

        this.initI18n();
        this.initEventListeners();
        this.initFaceRecognition();
        this.registerServiceWorker();
      }

      /* ========== إعداد نظام الترجمة ========== */
      initI18n() {
        i18next.init({
          lng: 'ar',
          debug: false,
          resources: {
            ar: { translation: {
              login: "تسجيل الدخول الآمن",
              username: "اسم المستخدم",
              password: "كلمة المرور",
              securityQuestion: "اختر سؤال الأمان",
              securityAnswer: "الإجابة",
              faceAuth: "تسجيل الدخول بالتعرف على الوجه",
              startScan: "بدء المسح",
              newNote: "ملاحظة جديدة",
              import: "استيراد",
              logout: "تسجيل الخروج",
              setup2FA: "إعداد 2FA",
              lockSession: "قفل الجلسة",
              save: "حفظ",
              archive: "أرشفة",
              delete: "حذف",
              search: "ابحث في الأرشيف..."
            }},
            en: { translation: {
              login: "Secure Login",
              username: "Username",
              password: "Password",
              securityQuestion: "Select a Security Question",
              securityAnswer: "Answer",
              faceAuth: "Face Recognition Login",
              startScan: "Start Scan",
              newNote: "New Note",
              import: "Import",
              logout: "Logout",
              setup2FA: "Setup 2FA",
              lockSession: "Lock Session",
              save: "Save",
              archive: "Archive",
              delete: "Delete",
              search: "Search Archive..."
            }}
          }
        }, () => {
          // يمكن تحديث النصوص في الواجهة بعد تهيئة i18n
          this.updateTranslations();
        });
      }

      updateTranslations() {
        // مثال على تحديث بعض العناصر (يمكن توسيع القائمة حسب الحاجة)
        document.querySelector('#auth-container h2').innerText = i18next.t('login');
        document.querySelector('sl-input[label="اسم المستخدم"]').label = i18next.t('username');
        document.querySelector('sl-input[label="كلمة المرور"]').label = i18next.t('password');
      }

      /* ========== تسجيل أحداث الواجهة ========== */
      initEventListeners() {
        document.getElementById('biometric-auth').addEventListener('click', () => this.handleBiometricAuth());
        document.getElementById('start-face-auth').addEventListener('click', () => this.faceLogin());
        document.getElementById('2fa-setup').addEventListener('click', () => this.setup2FA());
        document.getElementById('lock-session').addEventListener('click', () => this.lockSession());
        document.getElementById('logout').addEventListener('click', () => this.logout());
        document.getElementById('save-note').addEventListener('click', () => this.saveNote());
        document.getElementById('close-modal').addEventListener('click', () => this.closeModal());

        // تغيير لغة الواجهة عند اختيار لغة جديدة
        document.getElementById('language-select').addEventListener('sl-change', (event) => {
          const newLang = event.detail.value;
          i18next.changeLanguage(newLang, () => {
            this.updateTranslations();
          });
        });

        // إعادة ضبط مؤقت الجلسة عند تحريك الماوس
        window.addEventListener('mousemove', () => this.resetSessionTimer());

        // حفظ تلقائي للملاحظات أثناء الكتابة
        document.getElementById('note-editor').addEventListener('input', () => {
          this.autoSaveNote();
        });
      }

      /* ========== تهيئة التعرف على الوجه ========== */
      async initFaceRecognition() {
        try {
          await faceapi.nets.tinyFaceDetector.loadFromUri(this.modelsPath);
          const video = document.getElementById('face-video');
          const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
          video.srcObject = stream;
        } catch (error) {
          console.error('خطأ في تحميل نماذج التعرف على الوجه:', error);
          this.showModal('خطأ', 'تعذر تحميل نماذج التعرف على الوجه.');
        }
      }

      /* ========== تسجيل خدمة (Service Worker) للتطبيق التقدمي ========== */
      registerServiceWorker() {
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js').then(registration => {
              console.log('تم تسجيل خدمة التطبيق بنجاح:', registration);
            }).catch(error => {
              console.error('فشل تسجيل خدمة التطبيق:', error);
            });
          });
        }
      }

      /* ========== معالجة تسجيل الدخول البيومتري ========== */
      async handleBiometricAuth() {
        try {
          if (navigator.credentials && navigator.credentials.get) {
            // توليد تحدي عشوائي باستخدام Web Crypto API
            const challenge = new Uint8Array(32);
            window.crypto.getRandomValues(challenge);
            const credential = await navigator.credentials.get({
              publicKey: {
                challenge: challenge,
                rpId: window.location.hostname,
                userVerification: 'required'
              }
            });
            this.handleAuthSuccess(credential);
          } else {
            this.showModal('تنبيه', 'متصفحك لا يدعم واجهة الاعتماد البيومتري.');
          }
        } catch (error) {
          console.error('خطأ أثناء المصادقة البيومترية:', error);
          this.showModal('خطأ', 'فشلت عملية المصادقة البيومترية.');
        }
      }

      /* ========== التحقق من تسجيل الدخول بنجاح ========== */
      handleAuthSuccess(credential) {
        // هنا يمكن إضافة المزيد من الإجراءات الخاصة بالتحقق من صحة الاعتماد
        this.currentUser = document.getElementById('username').value || "المستخدم";
        // توليد مفتاح تشفير عشوائي باستخدام CryptoJS (يمكن استبداله بخوارزمية أكثر تطورًا)
        this.encryptionKey = CryptoJS.lib.WordArray.random(16).toString();
        document.getElementById('auth-container').hidden = true;
        document.getElementById('main-app').hidden = false;
        this.resetSessionTimer();
        this.loadSavedNote();
        this.showModal('تنبيه', 'تم تسجيل الدخول بنجاح.');
      }

      /* ========== تسجيل الدخول باستخدام التعرف على الوجه ========== */
      async faceLogin() {
        try {
          const video = document.getElementById('face-video');
          const canvas = document.getElementById('face-canvas');
          const context = canvas.getContext('2d');
          context.drawImage(video, 0, 0, canvas.width, canvas.height);
          const detections = await faceapi.detectAllFaces(canvas, new faceapi.TinyFaceDetectorOptions());
          
          if (detections.length > 0) {
            // استخراج ميزات الوجه (يمكن تطوير هذه الدالة لمزيد من الدقة)
            const faceData = detections[0];
            this.verifyFace(faceData);
          } else {
            this.showModal('تنبيه', 'لم يتم الكشف عن وجه. الرجاء المحاولة مرة أخرى.');
          }
        } catch (error) {
          console.error('خطأ أثناء التعرف على الوجه:', error);
          this.showModal('خطأ', 'حدث خطأ أثناء التعرف على الوجه.');
        }
      }

      /* ========== التحقق من بيانات الوجه (مؤقت للإيضاح) ========== */
      verifyFace(faceData) {
        // يمكن إضافة خوارزمية تحقق متقدمة هنا
        if (faceData) {
          // اعتبارًا من التحقق الناجح
          this.handleAuthSuccess(faceData);
        } else {
          this.showModal('تنبيه', 'لم يتم التعرف على الوجه بشكل صحيح.');
        }
      }

      /* ========== إعداد المصادقة الثنائية (2FA) ========== */
      setup2FA() {
        // توليد مفتاح سري باستخدام Web Crypto API
        const secret = this.generateSecret(32);
        const qrCodeData = `otpauth://totp/NotesApp?secret=${secret}&issuer=SecureNotes`;
        const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(qrCodeData)}`;
        this.showModal('QR Code', `<img src="${qrImageUrl}" alt="QR Code لتفعيل 2FA">`);
      }

      /* ========== توليد مفتاح سري باستخدام Web Crypto API ========== */
      generateSecret(length = 32) {
        const array = new Uint8Array(length);
        window.crypto.getRandomValues(array);
        return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
      }

      /* ========== إدارة مؤقت الجلسة ========== */
      resetSessionTimer() {
        clearTimeout(this.sessionTimeout);
        this.sessionTimeout = setTimeout(() => {
          this.lockSession();
        }, 300000); // 5 دقائق
      }

      lockSession() {
        document.getElementById('main-app').hidden = true;
        document.getElementById('auth-container').hidden = false;
        this.encryptionKey = null;
        this.currentUser = null;
        this.showModal('تنبيه', 'تم قفل الجلسة تلقائيًا بسبب عدم النشاط.');
      }

      logout() {
        this.lockSession();
        this.showModal('تنبيه', 'تم تسجيل الخروج بنجاح.');
      }

      /* ========== تشفير البيانات باستخدام CryptoJS ========== */
      encryptData(data) {
        if (!this.encryptionKey) return null;
        return CryptoJS.AES.encrypt(JSON.stringify(data), this.encryptionKey, { iv: this.iv }).toString();
      }

      /* ========== فك تشفير البيانات ========== */
      decryptData(ciphertext) {
        try {
          const bytes = CryptoJS.AES.decrypt(ciphertext, this.encryptionKey, { iv: this.iv });
          return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
        } catch (error) {
          console.error('خطأ في فك التشفير:', error);
          return null;
        }
      }

      /* ========== التحقق من صحة المدخلات باستخدام Regex ========== */
      validateInput(data) {
        const schema = {
          name: /^[\p{L} ]+$/u,
          birthDate: /^\d{4}-\d{2}-\d{2}$/
          // يمكن إضافة المزيد من قواعد التحقق هنا
        };

        return Object.entries(schema).every(([key, regex]) => regex.test(data[key]));
      }

      /* ========== حفظ الملاحظات تلقائيًا في التخزين المحلي ========== */
      autoSaveNote() {
        const noteContent = document.getElementById('note-editor').innerHTML;
        localStorage.setItem('savedNote', noteContent);
      }

      loadSavedNote() {
        const savedNote = localStorage.getItem('savedNote');
        if (savedNote) {
          document.getElementById('note-editor').innerHTML = savedNote;
        }
      }

      saveNote() {
        this.autoSaveNote();
        this.showModal('تنبيه', 'تم حفظ الملاحظة بنجاح.');
      }

      /* ========== دالة عرض حوار (Modal) للتنبيهات ========== */
      showModal(title, content) {
        const modal = document.getElementById('modal-dialog');
        modal.label = title;
        document.getElementById('modal-content').innerHTML = content;
        modal.show();
      }

      closeModal() {
        document.getElementById('modal-dialog').hide();
      }
    }

    // بدء النظام عند تحميل الصفحة
    window.addEventListener('DOMContentLoaded', () => {
      window.app = new SecureNotesSystem();
    });
  </script>
</body>
</html>
